#!/usr/bin/env bash

set -euo pipefail
shopt -s extglob
set -o allexport

debug=false
KEVM=kevm

notif() { echo "== ${KEVM}: $*" >&2 ; }

fatal() { notif "[FATAL] $*" ; exit 1 ; }

check_k_install() {
    which kast &> /dev/null \
        || fatal "Must have K installed! See https://github.com/kframework/k/releases."
    which krun &> /dev/null \
        || fatal "Must have K installed! See https://github.com/kframework/k/releases."
}

INSTALL_BIN="$(cd $(dirname $0) && pwd)"
INSTALL_LIB="$(dirname ${INSTALL_BIN})/lib/kevm"
INSTALL_INCLUDE=${INSTALL_LIB}/include

install_k_bin=${INSTALL_LIB}/kframework/bin
install_k_lib=${INSTALL_LIB}/kframework/lib

export PATH="${INSTALL_BIN}:${INSTALL_LIB}:${install_k_bin}:${PATH}"
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-}:/usr/local/lib

export K_OPTS="${K_OPTS:--Xmx16G -Xss512m}"


# Runners
# -------

run_kevm_pyk() {
    local pyk_command pyk_args
    pyk_command="$1" ; shift
    case "${pyk_command}" in
        run|prove|prove-legacy|solc-to-k|foundry-kompile|foundry-prove|view-kcfg|show-kcfg|prune-proof)
            pyk_args=(--definition "${backend_dir}")
            pyk_args+=(-I "${INSTALL_INCLUDE}/kframework")
            ;;
    esac
    ! ${debug} || pyk_args+=(--debug)
    kevm-pyk "${pyk_command}" "$@" "${pyk_args[@]}"
}

# User Commands

run_krun() {
    local cschedule cmode cchainid parser krun_args

    check_k_install

    krun_args=(--definition "${backend_dir}" "${run_file}")
    if ${debugger}; then
        cmode="Lbl${mode}{}()"
        cschedule="Lbl${schedule}'Unds'EVM{}()"
        cchainid="\dv{SortInt{}}(\"${chainid}\")"
        parser='cat'
        krun_args+=(--debugger)
        krun_args+=(-cSCHEDULE="${cschedule}" -pSCHEDULE="${parser}")
        krun_args+=(-cMODE="${cmode}" -pMODE="${parser}")
        krun_args+=(-cCHAINID="${cchainid}" -pCHAINID="${parser}")
        krun "${krun_args[@]}" "$@"
    else
        krun_args+=(--schedule ${schedule})
        krun_args+=(--mode ${mode})
        krun_args+=(--chainid ${chainid})
        run_kevm_pyk run "${krun_args[@]}" "$@"
    fi
}

# Main
# ----

backend="llvm"
debugger=false
mode=NORMAL
schedule=MERGE
chainid=1

if [[ $# -eq 0 ]]; then 
    run_command='help'
else 
    run_command="$1" ; shift
fi

if [[ "$run_command" == 'version' ]] || [[ "$run_command" == '--version' ]]; then
    notif "KEVM Version"
    cat $INSTALL_LIB/version
    exit 0
fi

[[ ! "${run_command}" == prove       ]] || backend=haskell
[[ ! "${run_command}" == solc-to-k   ]] || backend=haskell
[[ ! "${run_command}" == view-kcfg   ]] || backend=haskell
[[ ! "${run_command}" == show-kcfg   ]] || backend=haskell
[[ ! "${run_command}" == prune-proof ]] || backend=haskell
[[ ! "${run_command}" == foundry-*   ]] || backend=foundry
args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --debug)      debug=true         ; shift   ;;
        --debugger)   debugger=true      ; shift   ;;
        --backend)    backend="$2"       ; shift 2 ;;
        --definition) backend_dir="$2"   ; shift 2 ;;
        --mode)       mode="$2"          ; shift 2 ;;
        --schedule)   schedule="$2"      ; shift 2 ;;
        --chainid)    chainid="$2"       ; shift 2 ;;
        --help)       run_command='help' ; shift   ;;
        *)            args+=("$1")       ; shift   ;;
    esac
done

[[ "${#args[@]}" -le 0 ]] || set -- "${args[@]}"
backend_dir="${backend_dir:-$INSTALL_LIB/$backend}"

# get the run file
if [[ "${run_command}" == run ]]; then
    if [[ $# -gt 0 ]]; then
        run_file="$1" ; shift
        if [[ "${run_file}" == '-' ]]; then
            tmp_input="$(mktemp)"
            trap "rm -rf ${tmp_input}" INT TERM EXIT
            cat - > "${tmp_input}"
            run_file="${tmp_input}"
        fi
        [[ -f "${run_file}" ]] || fatal "File does not exist: ${run_file}"
    else
        fatal "Please provide a file!"
    fi
fi

! ${debug} || set -x

case "$run_command-$backend" in
    run-@(llvm|haskell|haskell-standalone) ) run_krun "$@" ;;
    @(kast|kompile|prune-proof|view-kcfg|show-kcfg|solc-to-k|prove|prove-legacy|foundry)-* ) run_kevm_pyk ${run_command} "$@" ;;
    @(help|--help)-* ) run_kevm_pyk --help ;;
    * ) run_kevm_pyk --help ; fatal "Unknown command on backend: $run_command $backend" ;;
esac
