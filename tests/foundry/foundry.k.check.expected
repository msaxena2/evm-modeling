requires "edsl.md"
requires "lemmas/int-simplification.k"

module TOKEN-BIN-RUNTIME
    imports public EDSL
    
    syntax Contract ::= TokenContract 
    
    syntax TokenContract ::= "Token" [klabel(contract_Token)]
    
    rule  ( #binRuntime ( Token ) => #parseByteStack ( "0x608060405234801561001057600080fd5b506004361061002b5760003560e01c8063a9059cbb14610030575b600080fd5b61004361003e3660046100c9565b610045565b005b610050338383610054565b5050565b6001600160a01b038316600090815260016020526040902054610078908290610117565b6001600160a01b0380851660009081526001602052604080822093909355908416815220546100a890829061012e565b6001600160a01b039092166000908152600160205260409020919091555050565b600080604083850312156100dc57600080fd5b82356001600160a01b03811681146100f357600080fd5b946020939093013593505050565b634e487b7160e01b600052601160045260246000fd5b60008282101561012957610129610101565b500390565b6000821982111561014157610141610101565b50019056fea264697066735822122099123615db5c56cfbe9db8e89f9a468439257c4d1afe9c7addba9dc854fdd3ac64736f6c634300080f0033" ) )
      
    
    syntax Int ::= TokenContract "." TokenField [macro(), klabel(field_Token)]
    
    syntax TokenField ::= "x" [klabel(field_Token_x)]
    
    syntax TokenField ::= "balances" "[" Int "]" [klabel(field_Token_balances)]
    
    syntax TokenField ::= "allowances" "[" Int "]" "[" Int "]" [klabel(field_Token_allowances)]
    
    syntax TokenField ::= "name" [klabel(field_Token_name)]
    
    syntax TokenField ::= "foos" "[" Int "]" "." "bar" [klabel(field_Token_foos_bar)]
    
    syntax TokenField ::= "foos" "[" Int "]" "." "baz" [klabel(field_Token_foos_baz)]
    
    syntax TokenField ::= "foos" "[" Int "]" "." "boo" [klabel(field_Token_foos_boo)]
    
    syntax TokenField ::= "foos" "[" Int "]" "." "frob" [klabel(field_Token_foos_frob)]
    
    rule  ( Token . x => #hashedLocation ( "Solidity" , 0 , .IntList ) )
      
    
    rule  ( Token . balances [ V0 ] => #hashedLocation ( "Solidity" , 1 , V0  .IntList ) )
      
    
    rule  ( Token . allowances [ V0 ] [ V1 ] => #hashedLocation ( "Solidity" , 2 , V0  V1  .IntList ) )
      
    
    rule  ( Token . name => #hashedLocation ( "Solidity" , 3 , .IntList ) )
      
    
    rule  ( Token . foos [ V0 ] . bar => #hashedLocation ( "Solidity" , 4 , V0  .IntList ) )
      
    
    rule  ( Token . foos [ V0 ] . baz => ( #hashedLocation ( "Solidity" , 4 , V0  .IntList ) +Int 1 ) )
      
    
    rule  ( Token . foos [ V0 ] . boo => ( #hashedLocation ( "Solidity" , 4 , V0  .IntList ) +Int 2 ) )
      
    
    rule  ( Token . foos [ V0 ] . frob => ( #hashedLocation ( "Solidity" , 4 , V0  .IntList ) +Int 3 ) )
      
    
    syntax ByteArray ::= TokenContract "." TokenMethod [function(), klabel(method_Token)]
    
    syntax TokenMethod ::= "transfer" "(" Int "," Int ")" [klabel(method_Token_transfer)]
    
    rule  ( Token . transfer ( V0_dst , V1_amount ) => #abiCallData ( "transfer" , #address ( V0_dst ) , #uint256 ( V1_amount ) , .TypedArgs ) )
       ensures ( #rangeAddress ( V0_dst )
       andBool ( #rangeUInt ( 256 , V1_amount )
               ))
      
    
    rule  ( selector ( "transfer" ) => 2835717307 )
      

endmodule

module TOKENTEST-BIN-RUNTIME
    imports public EDSL
    
    syntax Contract ::= TokenTestContract 
    
    syntax TokenTestContract ::= "TokenTest" [klabel(contract_TokenTest)]
    
    rule  ( #binRuntime ( TokenTest ) => #parseByteStack ( "0x6080604052348015600f57600080fd5b5060043610603c5760003560e01c80630a9254e4146041578063663bc990146041578063899eb49c146043575b600080fd5b005b6041604b565b565b6049634e487b7160e01b600052600160045260246000fdfea26469706673582212209b875e818f6af138d9e1b829d2ea3da072b0872740c57fd0a09db03e6513d72c64736f6c634300080f0033" ) )
      
    
    syntax ByteArray ::= TokenTestContract "." TokenTestMethod [function(), klabel(method_TokenTest)]
    
    syntax TokenTestMethod ::= "setUp" "(" ")" [klabel(method_TokenTest_setUp)]
    
    syntax TokenTestMethod ::= "test_1" "(" ")" [klabel(method_TokenTest_test_1)]
    
    syntax TokenTestMethod ::= "test_2" "(" ")" [klabel(method_TokenTest_test_2)]
    
    rule  ( TokenTest . setUp ( ) => #abiCallData ( "setUp" , .TypedArgs ) )
      
    
    rule  ( TokenTest . test_1 ( ) => #abiCallData ( "test_1" , .TypedArgs ) )
      
    
    rule  ( TokenTest . test_2 ( ) => #abiCallData ( "test_2" , .TypedArgs ) )
      
    
    rule  ( selector ( "setUp" ) => 177362148 )
      
    
    rule  ( selector ( "test_1" ) => 1715194256 )
      
    
    rule  ( selector ( "test_2" ) => 2308879516 )
      

endmodule

module VERIFICATION
    imports public TOKEN-BIN-RUNTIME
    imports public TOKENTEST-BIN-RUNTIME
    imports public INT-SIMPLIFICATION
    
    

endmodule

module TOKENTEST-BIN-RUNTIME-SPEC
    imports public TOKENTEST-BIN-RUNTIME
    
    claim [tokentest-0]: <kevm>
           <k>
             ( #execute => #halt )
             ~> _CONTINUATION
           </k>
           <exit-code>
             ( _EXITCODE_CELL => ?_EXIT_CODE_CELL_c89e25d9 )
           </exit-code>
           <mode>
             ( NORMAL => ?_MODE_CELL_c89e25d9 )
           </mode>
           <schedule>
             ( LONDON => ?_SCHEDULE_CELL_c89e25d9 )
           </schedule>
           <ethereum>
             <evm>
               <output>
                 ( _OUTPUT_CELL => ?_OUTPUT_CELL_c89e25d9 )
               </output>
               <statusCode>
                 ( _STATUSCODE_CELL => ?_STATUSCODE_CELL_c89e25d9 )
               </statusCode>
               <endPC>
                 ( _ENDPC_CELL => ?_ENDPC_CELL_c89e25d9 )
               </endPC>
               <callStack>
                 ( .List => ?_CALLSTACK_CELL_c89e25d9 )
               </callStack>
               <interimStates>
                 ( _INTERIMSTATES_CELL => ?_INTERIMSTATES_CELL_c89e25d9 )
               </interimStates>
               <touchedAccounts>
                 ( _TOUCHEDACCOUNTS_CELL => ?_TOUCHEDACCOUNTS_CELL_c89e25d9 )
               </touchedAccounts>
               <callState>
                 <program>
                   ( #binRuntime ( TokenTest ) => ?_PROGRAM_CELL_c89e25d9 )
                 </program>
                 <jumpDests>
                   ( #computeValidJumpDests ( #binRuntime ( TokenTest ) ) => ?_JUMPDESTS_CELL_c89e25d9 )
                 </jumpDests>
                 <id>
                   ( ACCT_ID => ?_ID_CELL_c89e25d9 )
                 </id>
                 <caller>
                   ( _CALLER_ID => ?_CALLER_CELL_c89e25d9 )
                 </caller>
                 <callData>
                   ( TokenTest . test_1 ( ) => ?_CALLDATA_CELL_c89e25d9 )
                 </callData>
                 <callValue>
                   ( _CALLVALUE_CELL => ?_CALLVALUE_CELL_c89e25d9 )
                 </callValue>
                 <wordStack>
                   ( .WordStack => ?_WORDSTACK_CELL_c89e25d9 )
                 </wordStack>
                 <localMem>
                   ( .Memory => ?_LOCALMEM_CELL_c89e25d9 )
                 </localMem>
                 <pc>
                   ( 0 => ?_PC_CELL_c89e25d9 )
                 </pc>
                 <gas>
                   ( #gas ( _VGAS ) => ?_GAS_CELL_c89e25d9 )
                 </gas>
                 <memoryUsed>
                   ( 0 => ?_MEMORYUSED_CELL_c89e25d9 )
                 </memoryUsed>
                 <callGas>
                   ( _CALLGAS_CELL => ?_CALLGAS_CELL_c89e25d9 )
                 </callGas>
                 <static>
                   ( _STATIC_CELL => ?_STATIC_CELL_c89e25d9 )
                 </static>
                 <callDepth>
                   ( 0 => ?_CALLDEPTH_CELL_c89e25d9 )
                 </callDepth>
               </callState>
               <substate>
                 <selfDestruct>
                   ( _SELFDESTRUCT_CELL => ?_SELFDESTRUCT_CELL_c89e25d9 )
                 </selfDestruct>
                 <log>
                   ( _LOG_CELL => ?_LOG_CELL_c89e25d9 )
                 </log>
                 <refund>
                   ( _REFUND_CELL => ?_REFUND_CELL_c89e25d9 )
                 </refund>
                 <accessedAccounts>
                   ( _ACCESSEDACCOUNTS_CELL => ?_ACCESSEDACCOUNTS_CELL_c89e25d9 )
                 </accessedAccounts>
                 <accessedStorage>
                   ( _ACCESSEDSTORAGE_CELL => ?_ACCESSEDSTORAGE_CELL_c89e25d9 )
                 </accessedStorage>
               </substate>
               <gasPrice>
                 ( _GASPRICE_CELL => ?_GASPRICE_CELL_c89e25d9 )
               </gasPrice>
               <origin>
                 ( _ORIGIN_ID => ?_ORIGIN_CELL_c89e25d9 )
               </origin>
               <blockhashes>
                 ( _BLOCKHASHES_CELL => ?_BLOCKHASHES_CELL_c89e25d9 )
               </blockhashes>
               <block>
                 <previousHash>
                   ( _PREVIOUSHASH_CELL => ?_PREVIOUSHASH_CELL_c89e25d9 )
                 </previousHash>
                 <ommersHash>
                   ( _OMMERSHASH_CELL => ?_OMMERSHASH_CELL_c89e25d9 )
                 </ommersHash>
                 <coinbase>
                   ( _COINBASE_CELL => ?_COINBASE_CELL_c89e25d9 )
                 </coinbase>
                 <stateRoot>
                   ( _STATEROOT_CELL => ?_STATEROOT_CELL_c89e25d9 )
                 </stateRoot>
                 <transactionsRoot>
                   ( _TRANSACTIONSROOT_CELL => ?_TRANSACTIONSROOT_CELL_c89e25d9 )
                 </transactionsRoot>
                 <receiptsRoot>
                   ( _RECEIPTSROOT_CELL => ?_RECEIPTSROOT_CELL_c89e25d9 )
                 </receiptsRoot>
                 <logsBloom>
                   ( _LOGSBLOOM_CELL => ?_LOGSBLOOM_CELL_c89e25d9 )
                 </logsBloom>
                 <difficulty>
                   ( _DIFFICULTY_CELL => ?_DIFFICULTY_CELL_c89e25d9 )
                 </difficulty>
                 <number>
                   ( _NUMBER_CELL => ?_NUMBER_CELL_c89e25d9 )
                 </number>
                 <gasLimit>
                   ( _GASLIMIT_CELL => ?_GASLIMIT_CELL_c89e25d9 )
                 </gasLimit>
                 <gasUsed>
                   ( _GASUSED_CELL => ?_GASUSED_CELL_c89e25d9 )
                 </gasUsed>
                 <timestamp>
                   ( _TIMESTAMP_CELL => ?_TIMESTAMP_CELL_c89e25d9 )
                 </timestamp>
                 <extraData>
                   ( _EXTRADATA_CELL => ?_EXTRADATA_CELL_c89e25d9 )
                 </extraData>
                 <mixHash>
                   ( _MIXHASH_CELL => ?_MIXHASH_CELL_c89e25d9 )
                 </mixHash>
                 <blockNonce>
                   ( _BLOCKNONCE_CELL => ?_BLOCKNONCE_CELL_c89e25d9 )
                 </blockNonce>
                 <baseFee>
                   ( _BASEFEE_CELL => ?_BASEFEE_CELL_c89e25d9 )
                 </baseFee>
                 <ommerBlockHeaders>
                   ( _OMMERBLOCKHEADERS_CELL => ?_OMMERBLOCKHEADERS_CELL_c89e25d9 )
                 </ommerBlockHeaders>
               </block>
             </evm>
             <network>
               <chainID>
                 ( _CHAINID_CELL => ?_CHAINID_CELL_c89e25d9 )
               </chainID>
               <activeAccounts>
                 ( _ACTIVEACCOUNTS_CELL => ?_ACTIVEACCOUNTS_CELL_c89e25d9 )
               </activeAccounts>
               <accounts>
                 ( ( <account>
                   <acctID>
                     ACCT_ID
                   </acctID>
                   <code>
                     #binRuntime ( TokenTest )
                   </code>
                   ...
                 </account>
                 _ACCOUNTS ) => ?_ACCOUNTS_CELL_c89e25d9 )
               </accounts>
               <txOrder>
                 ( _TXORDER_CELL => ?_TXORDER_CELL_c89e25d9 )
               </txOrder>
               <txPending>
                 ( _TXPENDING_CELL => ?_TXPENDING_CELL_c89e25d9 )
               </txPending>
               <messages>
                 ( _MESSAGES_CELL => ?_MESSAGES_CELL_c89e25d9 )
               </messages>
             </network>
           </ethereum>
         </kevm>
      [label(tokentest-0)]
    
    claim [tokentest-1]: <kevm>
           <k>
             ( #execute => #halt )
             ~> _CONTINUATION
           </k>
           <exit-code>
             ( _EXITCODE_CELL => ?_EXIT_CODE_CELL_c89e25d9 )
           </exit-code>
           <mode>
             ( NORMAL => ?_MODE_CELL_c89e25d9 )
           </mode>
           <schedule>
             ( LONDON => ?_SCHEDULE_CELL_c89e25d9 )
           </schedule>
           <ethereum>
             <evm>
               <output>
                 ( _OUTPUT_CELL => ?_OUTPUT_CELL_c89e25d9 )
               </output>
               <statusCode>
                 ( _STATUSCODE_CELL => ?_STATUSCODE_CELL_c89e25d9 )
               </statusCode>
               <endPC>
                 ( _ENDPC_CELL => ?_ENDPC_CELL_c89e25d9 )
               </endPC>
               <callStack>
                 ( .List => ?_CALLSTACK_CELL_c89e25d9 )
               </callStack>
               <interimStates>
                 ( _INTERIMSTATES_CELL => ?_INTERIMSTATES_CELL_c89e25d9 )
               </interimStates>
               <touchedAccounts>
                 ( _TOUCHEDACCOUNTS_CELL => ?_TOUCHEDACCOUNTS_CELL_c89e25d9 )
               </touchedAccounts>
               <callState>
                 <program>
                   ( #binRuntime ( TokenTest ) => ?_PROGRAM_CELL_c89e25d9 )
                 </program>
                 <jumpDests>
                   ( #computeValidJumpDests ( #binRuntime ( TokenTest ) ) => ?_JUMPDESTS_CELL_c89e25d9 )
                 </jumpDests>
                 <id>
                   ( ACCT_ID => ?_ID_CELL_c89e25d9 )
                 </id>
                 <caller>
                   ( _CALLER_ID => ?_CALLER_CELL_c89e25d9 )
                 </caller>
                 <callData>
                   ( TokenTest . test_2 ( ) => ?_CALLDATA_CELL_c89e25d9 )
                 </callData>
                 <callValue>
                   ( _CALLVALUE_CELL => ?_CALLVALUE_CELL_c89e25d9 )
                 </callValue>
                 <wordStack>
                   ( .WordStack => ?_WORDSTACK_CELL_c89e25d9 )
                 </wordStack>
                 <localMem>
                   ( .Memory => ?_LOCALMEM_CELL_c89e25d9 )
                 </localMem>
                 <pc>
                   ( 0 => ?_PC_CELL_c89e25d9 )
                 </pc>
                 <gas>
                   ( #gas ( _VGAS ) => ?_GAS_CELL_c89e25d9 )
                 </gas>
                 <memoryUsed>
                   ( 0 => ?_MEMORYUSED_CELL_c89e25d9 )
                 </memoryUsed>
                 <callGas>
                   ( _CALLGAS_CELL => ?_CALLGAS_CELL_c89e25d9 )
                 </callGas>
                 <static>
                   ( _STATIC_CELL => ?_STATIC_CELL_c89e25d9 )
                 </static>
                 <callDepth>
                   ( 0 => ?_CALLDEPTH_CELL_c89e25d9 )
                 </callDepth>
               </callState>
               <substate>
                 <selfDestruct>
                   ( _SELFDESTRUCT_CELL => ?_SELFDESTRUCT_CELL_c89e25d9 )
                 </selfDestruct>
                 <log>
                   ( _LOG_CELL => ?_LOG_CELL_c89e25d9 )
                 </log>
                 <refund>
                   ( _REFUND_CELL => ?_REFUND_CELL_c89e25d9 )
                 </refund>
                 <accessedAccounts>
                   ( _ACCESSEDACCOUNTS_CELL => ?_ACCESSEDACCOUNTS_CELL_c89e25d9 )
                 </accessedAccounts>
                 <accessedStorage>
                   ( _ACCESSEDSTORAGE_CELL => ?_ACCESSEDSTORAGE_CELL_c89e25d9 )
                 </accessedStorage>
               </substate>
               <gasPrice>
                 ( _GASPRICE_CELL => ?_GASPRICE_CELL_c89e25d9 )
               </gasPrice>
               <origin>
                 ( _ORIGIN_ID => ?_ORIGIN_CELL_c89e25d9 )
               </origin>
               <blockhashes>
                 ( _BLOCKHASHES_CELL => ?_BLOCKHASHES_CELL_c89e25d9 )
               </blockhashes>
               <block>
                 <previousHash>
                   ( _PREVIOUSHASH_CELL => ?_PREVIOUSHASH_CELL_c89e25d9 )
                 </previousHash>
                 <ommersHash>
                   ( _OMMERSHASH_CELL => ?_OMMERSHASH_CELL_c89e25d9 )
                 </ommersHash>
                 <coinbase>
                   ( _COINBASE_CELL => ?_COINBASE_CELL_c89e25d9 )
                 </coinbase>
                 <stateRoot>
                   ( _STATEROOT_CELL => ?_STATEROOT_CELL_c89e25d9 )
                 </stateRoot>
                 <transactionsRoot>
                   ( _TRANSACTIONSROOT_CELL => ?_TRANSACTIONSROOT_CELL_c89e25d9 )
                 </transactionsRoot>
                 <receiptsRoot>
                   ( _RECEIPTSROOT_CELL => ?_RECEIPTSROOT_CELL_c89e25d9 )
                 </receiptsRoot>
                 <logsBloom>
                   ( _LOGSBLOOM_CELL => ?_LOGSBLOOM_CELL_c89e25d9 )
                 </logsBloom>
                 <difficulty>
                   ( _DIFFICULTY_CELL => ?_DIFFICULTY_CELL_c89e25d9 )
                 </difficulty>
                 <number>
                   ( _NUMBER_CELL => ?_NUMBER_CELL_c89e25d9 )
                 </number>
                 <gasLimit>
                   ( _GASLIMIT_CELL => ?_GASLIMIT_CELL_c89e25d9 )
                 </gasLimit>
                 <gasUsed>
                   ( _GASUSED_CELL => ?_GASUSED_CELL_c89e25d9 )
                 </gasUsed>
                 <timestamp>
                   ( _TIMESTAMP_CELL => ?_TIMESTAMP_CELL_c89e25d9 )
                 </timestamp>
                 <extraData>
                   ( _EXTRADATA_CELL => ?_EXTRADATA_CELL_c89e25d9 )
                 </extraData>
                 <mixHash>
                   ( _MIXHASH_CELL => ?_MIXHASH_CELL_c89e25d9 )
                 </mixHash>
                 <blockNonce>
                   ( _BLOCKNONCE_CELL => ?_BLOCKNONCE_CELL_c89e25d9 )
                 </blockNonce>
                 <baseFee>
                   ( _BASEFEE_CELL => ?_BASEFEE_CELL_c89e25d9 )
                 </baseFee>
                 <ommerBlockHeaders>
                   ( _OMMERBLOCKHEADERS_CELL => ?_OMMERBLOCKHEADERS_CELL_c89e25d9 )
                 </ommerBlockHeaders>
               </block>
             </evm>
             <network>
               <chainID>
                 ( _CHAINID_CELL => ?_CHAINID_CELL_c89e25d9 )
               </chainID>
               <activeAccounts>
                 ( _ACTIVEACCOUNTS_CELL => ?_ACTIVEACCOUNTS_CELL_c89e25d9 )
               </activeAccounts>
               <accounts>
                 ( ( <account>
                   <acctID>
                     ACCT_ID
                   </acctID>
                   <code>
                     #binRuntime ( TokenTest )
                   </code>
                   ...
                 </account>
                 _ACCOUNTS ) => ?_ACCOUNTS_CELL_c89e25d9 )
               </accounts>
               <txOrder>
                 ( _TXORDER_CELL => ?_TXORDER_CELL_c89e25d9 )
               </txOrder>
               <txPending>
                 ( _TXPENDING_CELL => ?_TXPENDING_CELL_c89e25d9 )
               </txPending>
               <messages>
                 ( _MESSAGES_CELL => ?_MESSAGES_CELL_c89e25d9 )
               </messages>
             </network>
           </ethereum>
         </kevm>
      [label(tokentest-1)]

endmodule

